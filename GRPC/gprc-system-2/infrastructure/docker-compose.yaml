
services:
  # ====================================================================
  # 1. Eureka Discovery Server
  # ====================================================================
  discovery-server:
    image: discovery-server:1.0.0-SNAPSHOT
    build:
      dockerfile: ../Dockerfile
      context: ../discovery-server
      args:
        - ARTIFACT_NAME=discovery-server-1.0.0-SNAPSHOT
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      # Configure Eureka pour ne pas s'enregistrer et ne pas r√©cup√©rer (mode standalone)
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false

  # ====================================================================
  # 2. Product Service (Product-Service)
  # ====================================================================
  product-ms:
    image: product-ms:1.0.0-SNAPSHOT
    build:
      dockerfile: ../microservices/Dockerfile
      context: ../microservices/product-ms
      args:
        - ARTIFACT_NAME=product-service-1.0.0-SNAPSHOT
    container_name: product-ms
    ports:
      - "9090:9090" # Port gRPC
    environment:
      # R√©f√©rence le serveur Eureka par son nom de service Docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_APPLICATION_NAME=PRODUCT-MS
    depends_on:
      - discovery-server # D√©marre apr√®s le serveur Eureka
    restart: on-failure # Relance en cas d'√©chec

  # ====================================================================
  # 3. Order Service (Order-Service)
  # ====================================================================
  order-ms:
    image: order-ms:1.0.0-SNAPSHOT
    build:
      dockerfile: ../microservices/Dockerfile
      context: ../microservices/order-ms
      args:
        - ARTIFACT_NAME=order-ms-1.0.0-SNAPSHOT
    container_name: order-ms
    ports:
      - "9091:9091" # Port gRPC
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_APPLICATION_NAME=ORDER-MS
      # üîë Le client gRPC utilise le nom d'h√¥te Docker pour trouver le service
      - GRPC_CLIENT_PRODUCT_SERVICE_ADDRESS=eureka:PRODUCT-MS
    depends_on:
      - discovery-server
      - product-ms # D√©marre apr√®s le Product Service (bonne pratique)
    restart: on-failure

  # ====================================================================
  # 4. Payment Service (Payment-Service)
  # ====================================================================
  payment-ms:
    image: payment-ms:1.0.0-SNAPSHOT
    build:
      dockerfile: ../microservices/Dockerfile
      context: ../microservices/payment-ms
      args:
        - ARTIFACT_NAME=payment-service-1.0.0-SNAPSHOT
    container_name: payment-ms
    ports:
      - "9092:9092" # Port gRPC
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_APPLICATION_NAME=PAYMENT-MS
      # üîë Le client gRPC utilise le nom d'h√¥te Docker pour trouver le service
      - GRPC_CLIENT_ORDER_SERVICE_ADDRESS=eureka:ORDER-MS
    depends_on:
      - discovery-server
      - order-ms # D√©marre apr√®s l'Order Service
    restart: on-failure

  # ====================================================================
  # 5. Envoy Proxy (API Gateway)
  # ====================================================================
  envoy-proxy:
    image: envoyproxy/envoy-dev:latest
    container_name: envoy-proxy
    volumes:
      # Monte le fichier de configuration Envoy que nous avons cr√©√©
      - ./envoy.yaml:/etc/envoy/envoy.yaml:ro
    ports:
      - "8080:8080" # Le port d'entr√©e unique
    command: ["envoy", "-c", "/etc/envoy/envoy.yaml"]
    depends_on:
      # S'assure que tous les services sont d√©marr√©s avant qu'Envoy ne d√©marre
      - product-ms
      - order-ms
      - payment-ms

  # ====================================================================
  # 6. Config Server
  # ====================================================================
  config-server:
    image: config-server:1.0.0-SNAPSHOT
    build:
      dockerfile: ../config-server/Dockerfile
      context: ../config-server
      args:
        - ARTIFACT_NAME=config-server-1.0.0-SNAPSHOT
    container_name: config-server
    ports:
      - "8888:8888" # Port gRPC
    restart: on-failure # Relance en cas d'√©chec

  # ====================================================================
  # 7. Test Client
  # ====================================================================
#  test-client:
#    image: grpc-test-client:1.0.0-SNAPSHOT
#    build:
#      context: ./grpc-test-client
#      args:
#        # Assurez-vous que le nom du JAR correspond
#        - ARTIFACT_NAME=grpc-test-client-1.0.0-SNAPSHOT
#    container_name: test-client
#    # Nous n'avons pas besoin d'exposer de ports, car le client est un processus √©ph√©m√®re.
#    environment:
#      # üîë Le client doit pointer vers l'adresse d'Envoy au sein du r√©seau Docker.
#      # Le nom du service Docker Compose est 'envoy-proxy'.
#      - GRPC_CLIENT_GLOBAL_ADDRESS=static://envoy-proxy:8080
#      - GRPC_CLIENT_GLOBAL_NEGOTIATION_TYPE=PLAINTEXT
#    depends_on:
#      - envoy-proxy # Assurez-vous qu'Envoy est d√©marr√© et rout√© avant de tester
#    # üîë Ne pas red√©marrer, car c'est une commande unique.
#    restart: "no"